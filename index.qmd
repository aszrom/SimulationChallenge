

---
title: "Simulation Challenge"
subtitle: "Generative Models and Monte Carlo Simulation"
format:
  html: default
  pdf: default
execute:
  echo: true
  eval: true
---

# üé≤ Simulation Challenge - Monte Carlo Analysis

## Challenge Overview

**Your Mission:** Create a comprehensive Quarto document that simulates one or two investment strategies, analyzes the results, and demonstrates your ability to present counter-intuitive findings compellingly. Then render the document to HTML and deploy it via GitHub Pages from a new repository called "simulationChallenge."

## The Investment Game üéØ

### Original Game Strategy

::: {#exm-ErgodicityEconomicsExample}
Imagine you are offered the following game and given a $1,000 budget in a special account to play the game: I will flip a coin, and if it comes up heads, we increase your account's balance by 50%; if it comes up tails, we reduce your account's balance by 40%. We are not only doing this once, but we will do it once per year until you turn 55. When you turn 55, you will receive the balance in your account.
:::

### Generative DAG Model for the Investment Game

```{python}
#| echo: false
#| include: false
#| eval: false
import daft

# Create the DAG directly without custom class
investmentDAG = daft.PGM(dpi=150, alternate_style="outer")

# Initial wealth (deterministic)
investmentDAG.add_node("W0", "Initial Wealth\n$W_0 = 1000$", x=4, y=2.5, aspect=5.4, 
                      alternate=True, plot_params={'facecolor': 'aliceblue'})

# Time t nodes  
investmentDAG.add_node("Ct", "Coin Flip t\n$C_t \\sim \\text{Bernoulli}(0.5)$", x=0, y=1, aspect=4, scale = 1.6,
                      plot_params={'facecolor': 'aliceblue'})
investmentDAG.add_node("Wt", "\nWealth t\n$W_t = 1.5 \\times W_{t-1}$ if $C_t = 1$\n$W_t = 0.6 \\times W_{t-1}$ if $C_t = 0$\n", x=4, y=1, scale = 1.6, aspect=4,
                      alternate=True, plot_params={'facecolor': 'aliceblue'})

# Add edges showing the relationships
investmentDAG.add_edge("W0", "Wt")
investmentDAG.add_edge("Ct", "Wt")

# Add plate around time-dependent nodes
investmentDAG.add_plate([-2, 0.5, 7.8, 1.0], label="t = 1, ..., N", shift=-0.1)
```

```{python}
#| label: fig-investment-dag
#| fig-cap: Generative DAG model for the investment game showing how wealth evolves over time through coin flips
#| echo: false
#| eval: false
investmentDAG.show()
```

## Challenge Requirements üìã

### Questions to Answer for 75% Grade on Challenge

1. **Expected Value Analysis:** What is the "expected value" of your account balance after 1 coin flip for the original game?

2. **Expectation vs. Reality:** Is the expected value positive or negative? Do you expect your account to be worth more or less than $1,000 based on this result?

3. **Single Simulation:** Run one simulation showing the dynamics of your account balance over time. Make an object-oriented matplotlib OR ggplot2 plot showing your simulated account balance over time (i.e. as you age). Comment on the results, are you happy?

## Analysis and Solutions

### Question 1: Expected Value Analysis

**What is the "expected value" of your account balance after 1 coin flip for the original game?**

Let's calculate this step by step using R:

```{r}
#| label: expected-value-analysis
#| fig-cap: Expected value calculation for the investment game
#| echo: true

# Load required libraries
suppressPackageStartupMessages(library(tidyverse))

# Game parameters
initial_balance <- 1000
heads_multiplier <- 1.5  # +50% gain
tails_multiplier <- 0.6  # -40% loss
probability_heads <- 0.5

# Calculate expected value after 1 coin flip
# E[W1] = P(Heads) * W0 * 1.5 + P(Tails) * W0 * 0.6
# E[W1] = 0.5 * 1000 * 1.5 + 0.5 * 1000 * 0.6
# E[W1] = 0.5 * 1500 + 0.5 * 600
# E[W1] = 750 + 300 = 1050

expected_value_after_one_flip <- probability_heads * initial_balance * heads_multiplier + 
                                 (1 - probability_heads) * initial_balance * tails_multiplier

# Display the calculation
cat("Expected Value Calculation:\n")
cat("========================\n")
cat("Initial Balance: $", initial_balance, "\n")
cat("Heads (50% chance): $", initial_balance, " √ó 1.5 = $", initial_balance * heads_multiplier, "\n")
cat("Tails (50% chance): $", initial_balance, " √ó 0.6 = $", initial_balance * tails_multiplier, "\n")
cat("\nExpected Value = 0.5 √ó $", initial_balance * heads_multiplier, " + 0.5 √ó $", initial_balance * tails_multiplier, "\n")
cat("Expected Value = $", probability_heads * initial_balance * heads_multiplier, " + $", (1 - probability_heads) * initial_balance * tails_multiplier, "\n")
cat("Expected Value = $", expected_value_after_one_flip, "\n")

# Verify with simulation
set.seed(123)
n_sims <- 10000

# Simulate 10,000 single coin flips
simulated_balances <- replicate(n_sims, {
  coin_flip <- rbinom(1, 1, probability_heads)
  if (coin_flip == 1) {
    initial_balance * heads_multiplier
  } else {
    initial_balance * tails_multiplier
  }
})

# Calculate mean of simulations
simulated_expected_value <- mean(simulated_balances)

cat("\nSimulation Verification:\n")
cat("=======================\n")
cat("Simulated Expected Value (10,000 trials): $", round(simulated_expected_value, 2), "\n")
cat("Theoretical Expected Value: $", expected_value_after_one_flip, "\n")
cat("Difference: $", round(abs(simulated_expected_value - expected_value_after_one_flip), 2), "\n")
```

### Question 2: Expectation vs. Reality

**Is the expected value positive or negative? Do you expect your account to be worth more or less than $1,000 based on this result?**

```{r}
#| label: expectation-analysis
#| fig-cap: Analysis of expected value vs initial investment
#| echo: true

# Analysis of the expected value
cat("Expectation vs. Reality Analysis:\n")
cat("================================\n")
cat("Initial Investment: $", initial_balance, "\n")
cat("Expected Value after 1 flip: $", expected_value_after_one_flip, "\n")
cat("Expected Gain/Loss: $", expected_value_after_one_flip - initial_balance, "\n")
cat("Expected Return: ", round((expected_value_after_one_flip - initial_balance) / initial_balance * 100, 1), "%\n")

if (expected_value_after_one_flip > initial_balance) {
  cat("\n‚úÖ The expected value is POSITIVE!\n")
  cat("Based on this result, I expect my account to be worth MORE than $1,000.\n")
  cat("This suggests the game is favorable in the long run.\n")
} else {
  cat("\n‚ùå The expected value is NEGATIVE!\n")
  cat("Based on this result, I expect my account to be worth LESS than $1,000.\n")
  cat("This suggests the game is unfavorable in the long run.\n")
}

# However, let's think about this more carefully...
cat("\nü§î But wait! Let's think about this more carefully...\n")
cat("The expected value calculation assumes we can play this game many times.\n")
cat("But in reality, we only get to play once per year until age 55.\n")
cat("This is a key insight about ergodicity economics!\n")
```

### Question 3: Single Simulation

**Run one simulation showing the dynamics of your account balance over time. Make an object-oriented ggplot2 plot showing your simulated account balance over time (i.e. as you age). Comment on the results, are you happy?**

Let's simulate the investment game over multiple years to see how the account balance evolves:

```{r}
#| label: single-simulation
#| fig-cap: Single simulation of investment game showing account balance over time
#| echo: true

# Load required libraries
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(ggplot2))

# Set seed for reproducibility
set.seed(456)

# Game parameters
initial_balance <- 1000
heads_multiplier <- 1.5  # +50% gain
tails_multiplier <- 0.6  # -40% loss
probability_heads <- 0.5
years_to_simulate <- 30  # Simulate from age 25 to 55

# Function to simulate one complete investment path
simulate_investment_path <- function(initial, years, heads_mult, tails_mult, prob_heads) {
  balance <- initial
  path <- numeric(years + 1)
  path[1] <- initial
  
  for (year in 1:years) {
    coin_flip <- rbinom(1, 1, prob_heads)
    if (coin_flip == 1) {
      balance <- balance * heads_mult  # Heads: multiply by 1.5
    } else {
      balance <- balance * tails_mult  # Tails: multiply by 0.6
    }
    path[year + 1] <- balance
  }
  
  return(path)
}

# Run single simulation
single_path <- simulate_investment_path(initial_balance, years_to_simulate, 
                                       heads_multiplier, tails_multiplier, probability_heads)

# Create data frame for plotting
simulation_data <- tibble(
  year = 0:years_to_simulate,
  age = 25 + year,  # Assuming starting at age 25
  balance = single_path,
  log_balance = log(balance)
)

# Display the simulation results
cat("Single Investment Simulation Results:\n")
cat("====================================\n")
cat("Starting Age: 25\n")
cat("Ending Age: 55\n")
cat("Initial Balance: $", initial_balance, "\n")
cat("Final Balance: $", round(single_path[length(single_path)], 2), "\n")
cat("Total Return: ", round((single_path[length(single_path)] / initial_balance - 1) * 100, 1), "%\n")
cat("Annualized Return: ", round((single_path[length(single_path)] / initial_balance)^(1/years_to_simulate) - 1, 3) * 100, "%\n")

# Show first few and last few years
cat("\nFirst 5 years:\n")
print(simulation_data[1:6, c("age", "balance")])

cat("\nLast 5 years:\n")
print(simulation_data[(nrow(simulation_data)-4):nrow(simulation_data), c("age", "balance")])

# Create the time series plot
p1 <- ggplot(simulation_data, aes(x = age, y = balance)) +
  geom_line(color = "steelblue", linewidth = 1.2) +
  geom_point(color = "darkblue", size = 2) +
  geom_hline(yintercept = initial_balance, color = "red", linetype = "dashed", linewidth = 1) +
  labs(
    title = "Investment Game: Single Simulation Path",
    subtitle = paste("Account Balance from Age 25 to 55"),
    x = "Age",
    y = "Account Balance ($)",
    caption = "Red dashed line shows initial investment ($1,000)"
  ) +
  scale_y_continuous(
    labels = scales::dollar_format(),
    trans = "log10",
    breaks = c(100, 1000, 10000, 100000)
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12, color = "gray50"),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 11)
  )

print(p1)

# Analysis of the results
cat("\nüìä Analysis of Single Simulation:\n")
cat("================================\n")

if (single_path[length(single_path)] > initial_balance) {
  cat("‚úÖ This simulation was SUCCESSFUL!\n")
  cat("The account grew from $", initial_balance, " to $", round(single_path[length(single_path)], 2), "\n")
  cat("This represents a gain of $", round(single_path[length(single_path)] - initial_balance, 2), "\n")
} else {
  cat("‚ùå This simulation was UNSUCCESSFUL!\n")
  cat("The account shrank from $", initial_balance, " to $", round(single_path[length(single_path)], 2), "\n")
  cat("This represents a loss of $", round(initial_balance - single_path[length(single_path)], 2), "\n")
}

# Count wins vs losses by year
wins <- sum(single_path[-1] > single_path[-length(single_path)])
losses <- sum(single_path[-1] < single_path[-length(single_path)])

cat("\nYear-by-year breakdown:\n")
cat("Winning years: ", wins, "\n")
cat("Losing years: ", losses, "\n")
cat("Win rate: ", round(wins / (wins + losses) * 100, 1), "%\n")

# Key insights
cat("\nü§î Key Insights:\n")
cat("===============\n")
cat("1. Despite a positive expected value (+5% per year), this single path shows the reality of randomness.\n")
cat("2. The multiplicative nature of the game means early losses are very hard to recover from.\n")
cat("3. This single simulation doesn't tell us the full story - we need to look at many simulations.\n")
cat("4. The log scale plot shows the exponential nature of the growth/decay process.\n")
```


